# home assistant Script to take image from camera and convert to display format, requires shell commands: normalize_image_from_tmp_crop & cleanup_incoming
# exposed to voice assistant with alias "show outside camera"

alias: camera 2 display
description: ""
fields: {}
sequence:
  - variables:
      base: http://homeassistant.local:8123
      bust: "{{ now().timestamp() | int }}"
      final_url: "{{ base ~ '/local/slides/nowplaying.png?t=' ~ bust }}"
  - action: camera.snapshot
    data:
      entity_id: camera.c200_2_mainstream_2
      filename: /config/www/slides/_incoming.bin
  - delay: "00:00:01"
  - action: shell_command.normalize_image_from_tmp_crop
    data: {}
  - action: shell_command.cleanup_incoming
    data: {}
  - delay: "00:00:01"
  - data:
      url: "{{ final_url }}"
    action: esphome.esphome_web_d81da0_show_fullscreen_image
mode: single

#shell_command for configuration.yaml:
#  normalize_image_from_tmp: >
#    /usr/bin/ffmpeg -y -loglevel error -i /config/www/slides/_incoming.bin -vf scale=240:240:force_original_aspect_ratio=decrease,pad=240:240:(ow-iw)/2:(oh-ih)/2:color=black,format=rgb24 -vcodec png /config/www/slides/nowplaying.png
#  normalize_image_from_tmp_crop: >
#    /usr/bin/ffmpeg -y -loglevel error -i /config/www/slides/_incoming.bin -vf "scale=240:240:force_original_aspect_ratio=increase,crop=240:240,format=rgb24" -vcodec png /config/www/slides/nowplaying.png
#  cleanup_incoming: >
#    rm -f /config/www/slides/_incoming.bin
